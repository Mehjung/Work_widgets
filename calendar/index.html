<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalender Widget</title>
<style>
:root{--font:'Segoe UI',system-ui,-apple-system,sans-serif;--red:#ec0016;--bg:#fff;--bg-hover:#f6f7f9;--text:#1b1f24;--text2:#4b5563;--text3:#9ca3af;--border:#e5e7eb;--focus:#3b82f6;--holiday:#fef2f2;--holiday-text:#dc2626;--ferien:#eff6ff;--ferien-text:#2563eb}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);font-size:14px;color:var(--text);background:transparent;-webkit-font-smoothing:antialiased;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:8px}
.cal{width:100%;max-width:380px;margin:0 auto}
.cal-head{display:flex;align-items:center;justify-content:space-between;padding:0 4px 12px}
.cal-title{font-size:16px;font-weight:700;letter-spacing:-.3px}
.cal-nav{display:flex;gap:4px}
.cal-btn{width:28px;height:28px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text2);font-size:14px;transition:all .15s}
.cal-btn:hover{background:var(--bg-hover);color:var(--text)}
.cal-state{display:flex;align-items:center;gap:6px;padding:0 4px 10px}
.cal-state select{padding:3px 6px;border:1px solid var(--border);border-radius:5px;font-size:11px;font-family:inherit;color:var(--text2);background:var(--bg);cursor:pointer}
.cal-state select:focus{outline:none;border-color:var(--focus)}
.cal-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:1px}
.cal-grid.no-kw{grid-template-columns:repeat(7,1fr)}
.cal-wh{font-size:10px;font-weight:600;color:var(--text3);text-align:center;padding:4px 0 8px;text-transform:uppercase;letter-spacing:.5px}
.cal-kw{font-size:9px;color:var(--text3);display:flex;align-items:center;justify-content:center;font-weight:500}
.cal-day{position:relative;aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:12px;border-radius:6px;cursor:default;transition:background .12s}
.cal-day:hover{background:var(--bg-hover)}
.cal-day.other{color:var(--text3);opacity:.4}
.cal-day.today{background:var(--red);color:#fff;font-weight:700;border-radius:50%}
.cal-day.today:hover{background:var(--red)}
.cal-day.holiday{background:var(--holiday);color:var(--holiday-text);font-weight:600}
.cal-day.ferien{background:var(--ferien);color:var(--ferien-text)}
.cal-day.holiday.ferien{background:linear-gradient(135deg,var(--holiday),var(--ferien))}
.cal-day.weekend{color:var(--text3)}
.cal-day.holiday.today,.cal-day.ferien.today{background:var(--red);color:#fff}
.tooltip{display:none;position:absolute;bottom:calc(100% + 4px);left:50%;transform:translateX(-50%);background:var(--text);color:#fff;font-size:10px;padding:4px 8px;border-radius:4px;white-space:nowrap;z-index:10;pointer-events:none}
.cal-day:hover .tooltip{display:block}
.legend{display:flex;gap:12px;padding:10px 4px 0;flex-wrap:wrap}
.legend-item{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--text3)}
.legend-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}

body.dark{--bg:#1a1a2e;--bg-hover:rgba(255,255,255,.05);--text:#f0f0f0;--text2:rgba(255,255,255,.65);--text3:rgba(255,255,255,.3);--border:rgba(255,255,255,.08);--holiday:#3b1111;--holiday-text:#fca5a5;--ferien:#1e2a4a;--ferien-text:#93c5fd;background:#1a1a2e}
</style>
</head>
<body>
<div class="cal">
    <div class="cal-head">
        <span class="cal-title" id="title"></span>
        <div class="cal-nav">
            <button class="cal-btn" onclick="go(-1)">‹</button>
            <button class="cal-btn" onclick="goToday()">●</button>
            <button class="cal-btn" onclick="go(1)">›</button>
        </div>
    </div>
    <div class="cal-state" id="stateRow">
        <select id="blSelect" onchange="onStateChange()"></select>
    </div>
    <div class="cal-grid" id="grid"></div>
    <div class="legend" id="legend"></div>
</div>
<script>
const P=new URLSearchParams(location.search);
if(P.get('theme')==='dark') document.body.classList.add('dark');
const showKW=P.get('kw')!=='false';

const STATES={
    'BW':'Baden-Württemberg','BY':'Bayern','BE':'Berlin','BB':'Brandenburg',
    'HB':'Bremen','HH':'Hamburg','HE':'Hessen','MV':'Mecklenburg-Vorp.',
    'NI':'Niedersachsen','NW':'Nordrhein-Westfalen','RP':'Rheinland-Pfalz',
    'SL':'Saarland','SN':'Sachsen','ST':'Sachsen-Anhalt','SH':'Schleswig-Holstein','TH':'Thüringen'
};

let state=P.get('bl')||'SL';
let cur=new Date();
let viewY=cur.getFullYear(), viewM=cur.getMonth();
let holidays={}, ferien={};

// ===== BUNDESLAND SELECT =====
const sel=document.getElementById('blSelect');
Object.entries(STATES).forEach(([k,v])=>{
    const o=document.createElement('option');o.value=k;o.textContent=v;
    if(k===state) o.selected=true;
    sel.appendChild(o);
});
function onStateChange(){state=sel.value;loadAll()}

// ===== EASTER (Gauss/Anonymous algorithm) =====
function easter(y){
    const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4;
    const f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30;
    const i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7;
    const m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31);
    const day=((h+l-7*m+114)%31)+1;
    return new Date(y,month-1,day);
}

// ===== FEIERTAGE BERECHNEN =====
function calcHolidays(y){
    const e=easter(y);
    const d=(offset)=>{const dt=new Date(e);dt.setDate(dt.getDate()+offset);return dt};
    const fmt=(dt)=>`${y}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;

    // Bundesweite Feiertage
    const h={};
    h[`${y}-01-01`]='Neujahr';
    h[fmt(d(-2))]='Karfreitag';
    h[fmt(d(1))]='Ostermontag';
    h[`${y}-05-01`]='Tag der Arbeit';
    h[fmt(d(39))]='Christi Himmelfahrt';
    h[fmt(d(50))]='Pfingstmontag';
    h[`${y}-10-03`]='Tag der Dt. Einheit';
    h[`${y}-12-25`]='1. Weihnachtstag';
    h[`${y}-12-26`]='2. Weihnachtstag';

    // Hl. Drei Könige (BW, BY, ST)
    if(['BW','BY','ST'].includes(state)) h[`${y}-01-06`]='Hl. Drei Könige';
    // Internationaler Frauentag (BE)
    if(state==='BE') h[`${y}-03-08`]='Internationaler Frauentag';
    // Fronleichnam (BW, BY, HE, NW, RP, SL)
    if(['BW','BY','HE','NW','RP','SL'].includes(state)) h[fmt(d(60))]='Fronleichnam';
    // Mariä Himmelfahrt (SL, BY teilw.)
    if(['SL'].includes(state)) h[`${y}-08-15`]='Mariä Himmelfahrt';
    // Weltkindertag (TH)
    if(state==='TH') h[`${y}-09-20`]='Weltkindertag';
    // Reformationstag (BB, HB, HH, MV, NI, SN, ST, SH, TH)
    if(['BB','HB','HH','MV','NI','SN','ST','SH','TH'].includes(state)) h[`${y}-10-31`]='Reformationstag';
    // Allerheiligen (BW, BY, NW, RP, SL)
    if(['BW','BY','NW','RP','SL'].includes(state)) h[`${y}-11-01`]='Allerheiligen';
    // Buß- und Bettag (SN) – Mittwoch vor 23. Nov
    if(state==='SN'){
        const nov23=new Date(y,10,23);
        let bbt=new Date(nov23);
        const wd=nov23.getDay();
        bbt.setDate(nov23.getDate()-(wd>=3?wd-3:wd+4));
        h[fmt(bbt)]='Buß- und Bettag';
    }
    return h;
}

// ===== SCHULFERIEN (API) =====
async function loadFerien(y){
    ferien={};
    try{
        // Try openholidaysapi.org first
        const r=await fetch(`https://openholidaysapi.org/SchoolHolidays?countryIsoCode=DE&subdivisionCode=DE-${state}&languageIsoCode=DE&validFrom=${y}-01-01&validTo=${y}-12-31`,{headers:{accept:'text/json'}});
        if(r.ok){
            const data=await r.json();
            data.forEach(f=>{
                const name=f.name?.[0]?.text||f.name||'Ferien';
                const start=new Date(f.startDate);
                const end=new Date(f.endDate);
                for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){
                    const key=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                    ferien[key]=name;
                }
            });
        }
    }catch(e){/* API not reachable – silently fail */}
}

// ===== KW BERECHNEN =====
function getKW(d){
    const t=new Date(d.getFullYear(),d.getMonth(),d.getDate());
    t.setDate(t.getDate()+3-(t.getDay()+6)%7);
    const w1=new Date(t.getFullYear(),0,4);
    return 1+Math.round(((t-w1)/864e5-(3-(w1.getDay()+6)%7))/7);
}

// ===== RENDER =====
function render(){
    const grid=document.getElementById('grid');
    grid.className=showKW?'cal-grid':'cal-grid no-kw';
    const months=['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    document.getElementById('title').textContent=`${months[viewM]} ${viewY}`;

    const first=new Date(viewY,viewM,1);
    const startDay=(first.getDay()+6)%7; // Mo=0
    const daysInMonth=new Date(viewY,viewM+1,0).getDate();
    const prevDays=new Date(viewY,viewM,0).getDate();
    const today=new Date();
    const todayStr=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

    let html='';
    // Weekday headers
    if(showKW) html+='<div class="cal-wh">KW</div>';
    ['Mo','Di','Mi','Do','Fr','Sa','So'].forEach(d=>html+=`<div class="cal-wh">${d}</div>`);

    // Weeks
    const totalCells=startDay+daysInMonth;
    const rows=6; // always 6 rows for consistent height
    for(let r=0;r<rows;r++){
        // KW
        if(showKW){
            const kwDay=new Date(viewY,viewM,1-startDay+r*7+3);
            html+=`<div class="cal-kw">${getKW(kwDay)}</div>`;
        }
        for(let c=0;c<7;c++){
            const idx=r*7+c;
            const dayNum=idx-startDay+1;
            let cls='cal-day',tooltip='',dateStr='';

            if(dayNum<1){
                const d=prevDays+dayNum;
                cls+=' other';
                html+=`<div class="${cls}">${d}</div>`;
            }else if(dayNum>daysInMonth){
                cls+=' other';
                html+=`<div class="${cls}">${dayNum-daysInMonth}</div>`;
            }else{
                dateStr=`${viewY}-${String(viewM+1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`;
                if(dateStr===todayStr) cls+=' today';
                if(c>=5) cls+=' weekend';

                const hName=holidays[dateStr];
                const fName=ferien[dateStr];
                if(hName){cls+=' holiday';tooltip=hName}
                if(fName){cls+=' ferien';tooltip=tooltip?tooltip+' · '+fName:fName}

                const tt=tooltip?`<span class="tooltip">${tooltip}</span>`:'';
                html+=`<div class="${cls}">${dayNum}${tt}</div>`;
            }
        }
    }
    grid.innerHTML=html;

    // Legend
    const hasH=Object.keys(holidays).some(k=>k.startsWith(`${viewY}-${String(viewM+1).padStart(2,'0')}`));
    const hasF=Object.keys(ferien).some(k=>k.startsWith(`${viewY}-${String(viewM+1).padStart(2,'0')}`));
    let leg='';
    leg+=`<div class="legend-item"><div class="legend-dot" style="background:var(--red);border-radius:50%"></div>Heute</div>`;
    if(hasH) leg+=`<div class="legend-item"><div class="legend-dot" style="background:var(--holiday)"></div>Feiertag</div>`;
    if(hasF) leg+=`<div class="legend-item"><div class="legend-dot" style="background:var(--ferien)"></div>Schulferien</div>`;
    document.getElementById('legend').innerHTML=leg;
}

function go(dir){viewM+=dir;if(viewM>11){viewM=0;viewY++}if(viewM<0){viewM=11;viewY--}loadAll()}
function goToday(){viewY=cur.getFullYear();viewM=cur.getMonth();loadAll()}

async function loadAll(){
    holidays=calcHolidays(viewY);
    await loadFerien(viewY);
    render();
}

loadAll();
</script>
</body>
</html>
