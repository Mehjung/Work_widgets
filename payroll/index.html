<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Entgeltabschluss Countdown</title>
<style>
:root{--font:'Segoe UI',system-ui,-apple-system,sans-serif;--red:#ec0016;--bg:#fff;--text:#1b1f24;--text2:#4b5563;--text3:#9ca3af;--border:#e5e7eb}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);color:var(--text);background:transparent;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:16px;-webkit-font-smoothing:antialiased}
.cd{text-align:center;width:100%;max-width:480px}
.cd-title{font-size:13px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:16px}
.cd-blocks{display:flex;justify-content:center;gap:12px;margin-bottom:16px}
.cd-block{min-width:64px}
.cd-num{font-size:36px;font-weight:800;letter-spacing:-1px;color:var(--text);line-height:1}
.cd-label{font-size:10px;font-weight:500;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-top:4px}
.cd-bar-wrap{height:4px;background:var(--border);border-radius:2px;overflow:hidden}
.cd-bar{height:100%;background:var(--red);border-radius:2px;transition:width 1s ease}
.cd-target{font-size:11px;color:var(--text3);margin-top:10px}
.cd-done{font-size:22px;font-weight:700;color:var(--red);padding:20px}
.cd-done-sub{font-size:12px;color:var(--text3);margin-top:4px;font-weight:400}
.compact .cd-blocks{gap:8px;margin-bottom:10px}
.compact .cd-num{font-size:24px}
.compact .cd-title{font-size:11px;margin-bottom:10px}
body.dark{--bg:#1a1a2e;--text:#f0f0f0;--text2:rgba(255,255,255,.65);--text3:rgba(255,255,255,.3);--border:rgba(255,255,255,.1);background:#1a1a2e}
</style>
</head>
<body>
<div class="cd" id="cd"></div>
<script>
const P=new URLSearchParams(location.search);
if(P.get('theme')==='dark') document.body.classList.add('dark');
if(P.get('compact')==='true') document.querySelector('.cd').classList.add('compact');

const title=P.get('title')||'Entgeltabschluss';
const doneMsg=P.get('done')||'Heute ist Abschlusstag';
const nth=parseInt(P.get('n')||'4'); // n-th business day

/* ===== EASTER (Gauss) ===== */
function easter(y){
    const a=y%19,b=Math.floor(y/100),c=y%100,d=Math.floor(b/4),e=b%4;
    const f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30;
    const i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7;
    const m=Math.floor((a+11*h+22*l)/451),month=Math.floor((h+l-7*m+114)/31);
    const day=((h+l-7*m+114)%31)+1;
    return new Date(y,month-1,day);
}

/* ===== BUNDESWEITE FEIERTAGE ===== */
function federalHolidays(y){
    const e=easter(y);
    const d=(off)=>{const dt=new Date(e);dt.setDate(dt.getDate()+off);return fmt(dt)};
    const fmt=(dt)=>`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
    return new Set([
        `${y}-01-01`,   // Neujahr
        d(-2),           // Karfreitag
        d(1),            // Ostermontag
        `${y}-05-01`,   // Tag der Arbeit
        d(39),           // Christi Himmelfahrt
        d(50),           // Pfingstmontag
        `${y}-10-03`,   // Tag der Dt. Einheit
        `${y}-12-25`,   // 1. Weihnachtstag
        `${y}-12-26`,   // 2. Weihnachtstag
    ]);
}

/* ===== N-TH BUSINESS DAY OF MONTH ===== */
function nthBusinessDay(year, month, n){
    const holidays=federalHolidays(year);
    let count=0;
    for(let day=1;day<=31;day++){
        const dt=new Date(year,month,day);
        if(dt.getMonth()!==month) break; // month overflow
        const dow=dt.getDay();
        if(dow===0||dow===6) continue; // weekend
        const key=`${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        if(holidays.has(key)) continue; // federal holiday
        count++;
        if(count===n) return dt;
    }
    return null; // should not happen
}

/* ===== FIND TARGET ===== */
function findTarget(){
    const now=new Date();
    const todayStart=new Date(now.getFullYear(),now.getMonth(),now.getDate());

    // Try current month first
    const thisMonth=nthBusinessDay(now.getFullYear(),now.getMonth(),nth);
    if(thisMonth && todayStart<thisMonth){
        return thisMonth;
    }
    if(thisMonth && todayStart.getTime()===thisMonth.getTime()){
        return thisMonth; // today IS the day → show done
    }

    // Next month
    let nextM=now.getMonth()+1, nextY=now.getFullYear();
    if(nextM>11){nextM=0;nextY++}
    return nthBusinessDay(nextY,nextM,nth);
}

function pad(n){return String(n).padStart(2,'0')}
function formatDate(d){
    const days=['So','Mo','Di','Mi','Do','Fr','Sa'];
    const months=['Jan','Feb','Mär','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
    return`${days[d.getDay()]}, ${d.getDate()}. ${months[d.getMonth()]} ${d.getFullYear()}`;
}

let target=findTarget();

function tick(){
    const now=new Date();
    const todayStart=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    const targetStart=new Date(target.getFullYear(),target.getMonth(),target.getDate());

    // Check if target day has passed → recalculate
    if(todayStart>targetStart){
        target=findTarget();
    }

    // Today IS the target day → show done
    if(todayStart.getTime()===targetStart.getTime()){
        document.getElementById('cd').innerHTML=`
            <div class="cd-done">${doneMsg}
                <div class="cd-done-sub">${formatDate(target)}</div>
            </div>`;
        return;
    }

    // Countdown to target (midnight of target day)
    const diff=targetStart-now;
    const d=Math.floor(diff/864e5);
    const h=Math.floor((diff%864e5)/36e5);
    const m=Math.floor((diff%36e5)/6e4);
    const s=Math.floor((diff%6e4)/1e3);

    // Progress bar: days from now to target
    const totalDays=Math.ceil((targetStart-todayStart)/864e5);
    const elapsed=totalDays-(diff/864e5);
    const pct=Math.min(100,Math.max(0,(elapsed/totalDays)*100));

    document.getElementById('cd').innerHTML=`
        <div class="cd-title">${title}</div>
        <div class="cd-blocks">
            <div class="cd-block"><div class="cd-num">${d}</div><div class="cd-label">Tage</div></div>
            <div class="cd-block"><div class="cd-num">${pad(h)}</div><div class="cd-label">Std</div></div>
            <div class="cd-block"><div class="cd-num">${pad(m)}</div><div class="cd-label">Min</div></div>
            <div class="cd-block"><div class="cd-num">${pad(s)}</div><div class="cd-label">Sek</div></div>
        </div>
        <div class="cd-bar-wrap"><div class="cd-bar" style="width:${pct.toFixed(1)}%"></div></div>
        <div class="cd-target">${formatDate(target)}</div>
    `;
}

tick();
setInterval(tick,1000);
</script>
</body>
</html>
