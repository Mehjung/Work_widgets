<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ticker Widget</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;display:flex;align-items:center;min-height:100vh;background:transparent;overflow:hidden;-webkit-font-smoothing:antialiased}
.tk{width:100%;overflow:hidden;position:relative;padding:12px 0}
.tr{display:inline-flex;white-space:nowrap;will-change:transform}
.tr.running{animation:sc var(--dur) linear infinite}
.tr:hover{animation-play-state:paused}
@keyframes sc{0%{transform:translateX(0)}100%{transform:translateX(var(--dist))}}
.set{display:inline-flex;white-space:nowrap}
.ti{display:inline-flex;align-items:center;gap:8px;padding:0 32px;font-size:13px;color:#333}
.ti .dot{width:6px;height:6px;border-radius:50%;background:#ec0016;flex-shrink:0}
.ti .badge{padding:2px 8px;border-radius:4px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;flex-shrink:0}
.badge.wichtig{background:#ec0016;color:#fff}
.badge.info{background:#0ea5e9;color:#fff}
.badge.erfolg{background:#16a34a;color:#fff}
.badge.termin{background:#f59e0b;color:#fff}
.badge.hinweis{background:#8b5cf6;color:#fff}
.sep{display:inline-flex;padding:0 24px;color:#ddd;font-size:16px}
.lbl{position:absolute;left:0;top:0;bottom:0;z-index:2;display:flex;align-items:center;padding:0 16px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;background:#ec0016;color:#fff}
.lbl::after{content:'';position:absolute;right:-12px;top:0;bottom:0;width:12px;background:linear-gradient(90deg,rgba(0,0,0,.1),transparent)}
.has-lbl .tk{padding-left:100px}
body.dark{background:#1a1a2e}
body.dark .ti{color:rgba(255,255,255,.7)}
body.dark .sep{color:rgba(255,255,255,.15)}
.empty{width:100%;text-align:center;padding:12px;font-size:12px;color:#999}
</style>
</head>
<body>
<div style="width:100%;position:relative" id="wr">
    <div class="tk"><div class="tr" id="tr"></div></div>
</div>
<script>
const P=new URLSearchParams(location.search);
if(P.get('theme')==='dark') document.body.classList.add('dark');

const speed=parseInt(P.get('speed')||'30');
const label=P.get('label')||'';

function b64decode(s){try{return decodeURIComponent(escape(atob(s)))}catch(e){return atob(s)}}

function loadData(){
    const b64=P.get('json');
    if(b64){try{const d=JSON.parse(b64decode(b64));return d.items||d}catch(e){return[]}}
    const raw=P.get('items');
    if(raw){return raw.split(';;').map(r=>{const[b,t]=r.includes('|')?r.split('|',2):['',r];return{badge:b.trim().toLowerCase(),text:t.trim()}}).filter(i=>i.text)}
    return[];
}

const items=loadData();

if(!items.length){
    document.getElementById('wr').innerHTML='<div class="empty">Keine Nachrichten konfiguriert</div>';
}else{
    function itemsHtml(){
        return items.map(i=>{
            const bh=i.badge?`<span class="badge ${i.badge}">${i.badge}</span>`:'<span class="dot"></span>';
            return`<span class="ti">${bh} ${i.text}</span><span class="sep">◆</span>`;
        }).join('');
    }

    const tr=document.getElementById('tr');
    const html=itemsHtml();

    // 1) Render one set to measure its width
    tr.innerHTML=`<span class="set" id="measure">${html}</span>`;
    const setWidth=document.getElementById('measure').getBoundingClientRect().width;

    // 2) How many copies to fill at least 1 full viewport
    const copies=Math.max(1, Math.ceil(window.innerWidth/setWidth));

    // 3) Build one "half" that's guaranteed wider than viewport
    let halfHtml='';
    for(let i=0;i<copies;i++) halfHtml+=html;

    // 4) Two identical halves: A B A B → scroll A away, B takes over seamlessly
    tr.innerHTML=`<span class="set" id="halfA">${halfHtml}</span><span class="set">${halfHtml}</span>`;

    // 5) Measure the exact half-width and set as scroll distance
    const halfWidth=document.getElementById('halfA').getBoundingClientRect().width;
    tr.style.setProperty('--dist', `-${halfWidth}px`);
    tr.style.setProperty('--dur', `${speed}s`);
    tr.classList.add('running');
}

if(label){
    const w=document.getElementById('wr');
    w.classList.add('has-lbl');
    const l=document.createElement('div');
    l.className='lbl';l.textContent=label;
    w.insertBefore(l,w.firstChild);
}
</script>
</body>
</html>
